using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;

public class AmongUsGameController : MonoBehaviour
{
    [Header("--- OYUNCU VE ROL AYARLARI ---")]
    public List<PlayerMember> allPlayers = new List<PlayerMember>();
    public int totalImpostors = 1;
    public int totalDoctors = 1;
    
    [Header("--- ADMIN KONTROLLERİ ---")]
    public bool isLocalPlayerAdmin;
    public GameObject adminPanelUI;

    [Header("--- OYLAMA SİSTEMİ UI ---")]
    public GameObject voteIconPrefab; // Oy verenlerin küçük kafa ikonları
    public float votingTimer = 60f;
    private bool isVotingActive = false;
    private Dictionary<string, string> voteData = new Dictionary<string, string>(); // <OyVerenID, HedefID>

    [Header("--- DOKTOR HAFIZASI ---")]
    private string lastProtectedPlayerID = "";

    // --- 1. ADMIN YETKİLERİ ---
    public void UpdateGameSettings(int newImpostorCount, int newDoctorCount)
    {
        if (!isLocalPlayerAdmin) return;
        
        totalImpostors = newImpostorCount;
        totalDoctors = newDoctorCount;
        Debug.Log("Admin rolleri güncelledi: Impostor=" + totalImpostors);
    }

    public void AdminKickPlayer(string playerID)
    {
        if (isLocalPlayerAdmin)
        {
            // Oyuncuyu ağdan atma kodu buraya gelir
            Debug.Log("Admin oyuncuyu attı: " + playerID);
        }
    }

    // --- 2. SOHBET KONTROLÜ (ÖLÜLER YAZAMAZ) ---
    public void OnChatMessageSent(string message, PlayerMember sender)
    {
        if (!sender.isAlive)
        {
            // Sadece ölülerin görebileceği özel bir kanal
            DisplayGhostMessage(sender.playerName + " (GHOST): " + message);
        }
        else
        {
            // Herkesin görebileceği genel kanal
            DisplayGlobalMessage(sender.playerName + ": " + message);
        }
    }

    // --- 3. DOKTOR ÖZELLİĞİ (ÜST ÜSTE KORUMA ENGELİ) ---
    public void DoctorAction(PlayerMember doctor, PlayerMember target)
    {
        if (doctor.role != PlayerRole.Doctor) return;

        // Kendini koruma kontrolü
        if (target.playerID == doctor.playerID)
        {
            if (lastProtectedPlayerID == doctor.playerID)
            {
                Debug.LogWarning("Doktor üst üste iki tur kendini koruyamaz!");
                ShowNotification("Kendini koruma beklemede!");
                return;
            }
        }

        // Koruma başarılı
        target.isProtected = true;
        lastProtectedPlayerID = target.playerID;
        Debug.Log("Doktor korudu: " + target.playerName);
    }

    // --- 4. OYLAMA VE GÖRSEL İKON SİSTEMİ ---
    public void CastVote(string voterID, string targetID)
    {
        if (!isVotingActive) return;
        
        if (!voteData.ContainsKey(voterID))
        {
            voteData.Add(voterID, targetID);
            Debug.Log(voterID + " oyunu kullandı.");
        }
    }

    

    public void EndVotingAndShowResults()
    {
        isVotingActive = false;
        
        foreach (var player in allPlayers)
        {
            // Fotoğraftaki gibi her oyuncu kutusunun altındaki 'VoteContainer'ı bul
            Transform container = player.playerUIBox.transform.Find("VoteContainer");
            
            // Önceki ikonları temizle
            foreach (Transform child in container) Destroy(child.gameObject);

            // Kim bu oyuncuya oy verdiyse ikonunu ekle
            foreach (var vote in voteData)
            {
                if (vote.Value == player.playerID)
                {
                    PlayerMember voter = GetPlayerByID(vote.Key);
                    CreateVoteIcon(container, voter.playerColor);
                }
            }
        }
        
        voteData.Clear(); // Tur sonu verileri sıfırla
    }

    private void CreateVoteIcon(Transform parent, Color color)
    {
        GameObject icon = Instantiate(voteIconPrefab, parent);
        icon.GetComponent<Image>().color = color;
    }

    private PlayerMember GetPlayerByID(string id) => allPlayers.Find(p => p.playerID == id);
    private void DisplayGhostMessage(string msg) { /* UI Kodları */ }
    private void DisplayGlobalMessage(string msg) { /* UI Kodları */ }
    private void ShowNotification(string text) { /* UI Bildirim */ }
}

// --- YARDIMCI SINIFLAR ---
public enum PlayerRole { Crewmate, Impostor, Doctor }

[System.Serializable]
public class PlayerMember
{
    public string playerID;
    public string playerName;
    public Color playerColor;
    public bool isAlive = true;
    public bool isProtected = false;
    public PlayerRole role;
    public GameObject playerUIBox; // Oylama ekranındaki dikdörtgen panel
}
