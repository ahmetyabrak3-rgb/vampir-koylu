<script type="module">
    // ... Firebase baÄŸlantÄ± ayarlarÄ±n (initializeApp, db vb.) aynÄ± kalsÄ±n ...

    let hasVoted = false; // Bu turda oy verip vermediÄŸini takip eder

    // --- OYUN AKIÅI DÃ–NGÃœSÃœ ---
    async function handlePhases(data) {
        // ... (DiÄŸer fazlar aynÄ±) ...

        if(data.phase === 'voting') {
            phaseTitle.textContent = "ğŸ—³ï¸ OYLAMA ZAMANI";
            document.body.style.background = "#44337a";
            
            // SADECE HAYATTAYSA VE HENÃœZ OY VERMEDÄ°YSE BUTONLARI GÃ–STER
            if(isAlive && !hasVoted) {
                Object.entries(data.players).forEach(([key, p]) => {
                    if(p.status === 'alive') {
                        actionList.innerHTML += `<button class="btn btn-vote" onclick="voteAction('${key}')">${p.ad}</button>`;
                    }
                });
            } else if (!isAlive) {
                actionList.innerHTML = "<p style='color: #e53e3e;'>Ã–lÃ¼ler oy kullanamaz!</p>";
            } else {
                actionList.innerHTML = "<p>Oyunuzu kullandÄ±nÄ±z, sonuÃ§lar bekleniyor...</p>";
            }
        } else {
            // Yeni faz baÅŸladÄ±ÄŸÄ±nda oy verme kilidini sÄ±fÄ±rla
            hasVoted = false; 
        }
    }

    // --- GÃœVENLÄ° OYLAMA FONKSÄ°YONU ---
    window.voteAction = (targetKey) => {
        if(hasVoted || !isAlive) return; // Zaten vermiÅŸse veya Ã¶lÃ¼yse iÅŸlem yapma

        const voteRef = ref(db, `rooms/${currentRoom}/players/${targetKey}/votes`);
        
        // Firebase'deki oyu 1 artÄ±r
        onValue(voteRef, (s) => {
            const currentVotes = s.val() || 0;
            update(ref(db, `rooms/${currentRoom}/players/${targetKey}`), { votes: currentVotes + 1 });
            
            hasVoted = true; // Yerel olarak kilidi kapat
            document.getElementById('gameActionList').innerHTML = "Oyunuz baÅŸarÄ±yla kaydedildi.";
        }, {onlyOnce: true});
    };

    // --- LÄ°DERÄ°N OY SONUCU HESAPLAMASI (GELÄ°ÅMÄ°Å) ---
    async function calculateVotingResult() {
        const finalSnap = await new Promise(res => onValue(ref(db, `rooms/${currentRoom}/players`), res, {onlyOnce:true}));
        const players = finalSnap.val();
        
        let maxVotes = 0;
        let candidates = [];

        // OylarÄ± say
        Object.entries(players).forEach(([k, p]) => {
            if(p.votes > maxVotes) {
                maxVotes = p.votes;
                candidates = [k]; // Yeni lider aday
            } else if (p.votes === maxVotes && maxVotes > 0) {
                candidates.push(k); // Beraberlik listesine ekle
            }
            // Bir sonraki tur iÃ§in oylarÄ± temizle
            update(ref(db, `rooms/${currentRoom}/players/${k}`), { votes: 0 });
        });

        // SONUÃ‡: Sadece tek bir kiÅŸi en yÃ¼ksek oyu aldÄ±ysa elenir
        if(candidates.length === 1) {
            const eliminatedKey = candidates[0];
            update(ref(db, `rooms/${currentRoom}/players/${eliminatedKey}`), { status: 'dead' });
            return players[eliminatedKey].ad + " oylamayla elendi!";
        } else {
            return "Oylama berabere bitti, kimse elenmedi!";
        }
    }
</script>
