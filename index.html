// Önemli: get metodunu import kısmına eklemeyi unutma:
// import { getDatabase, ref, set, push, onValue, update, get } from "...";

window.oyunuBaslat = async () => {
    const adminOlsun = document.getElementById('adminOyuncuMu').value === "true";
    const nS = parseInt(document.getElementById('sureGece').value);
    const dS = parseInt(document.getElementById('sureTartisma').value);
    const vS = parseInt(document.getElementById('sureOylama').value);

    // 1. Admin oyuncu olarak katılacaksa ekle
    if(adminOlsun && liderMiyim && !benimAnahtarim) {
        const pRef = push(ref(db, `rooms/${mevcutOda}/players`), { ad: benimAdim, rol: '?', status: 'alive', votes: 0 });
        benimAnahtarim = pRef.key;
    }

    // 2. Oyuncuları bir kez çek ve rolleri dağıt
    const snapshot = await get(ref(db, `rooms/${mevcutOda}/players`));
    const oyuncular = snapshot.val();
    
    if(!oyuncular || Object.keys(oyuncular).length < 2) {
        alert("Oyunu başlatmak için en az 2 oyuncu gerekiyor!");
        return;
    }

    const anahtarlar = Object.keys(oyuncular);
    const vKey = anahtarlar[Math.floor(Math.random() * anahtarlar.length)];

    // Rolleri güncelle
    const updates = {};
    anahtarlar.forEach(k => {
        updates[`rooms/${mevcutOda}/players/${k}/rol`] = (k === vKey ? 'VAMPİR' : 'KÖYLÜ');
    });
    
    // Oyun bilgilerini güncelle
    updates[`rooms/${mevcutOda}/vampireName`] = oyuncular[vKey].ad;
    updates[`rooms/${mevcutOda}/phase`] = 'night'; // Direkt başlat
    
    await update(ref(db), updates);
    
    // Döngüyü başlat
    oyunDongusu(nS, dS, vS);
};
