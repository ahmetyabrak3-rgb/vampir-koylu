<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vampir K√∂yl√º - Pro S√ºr√ºm</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-night: #0f172a;
            --bg-day: #38bdf8;
            --card-night: #1e293b;
            --card-day: #f0f9ff;
            --text-night: #f8fafc;
            --text-day: #0f172a;
            --accent: #fbbf24;
            --vampire: #ef4444;
            --doctor: #22c55e;
            --secondary: #475569;
        }

        body { 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-night); 
            color: var(--text-night); 
            overflow: hidden; 
            transition: background 1s ease;
        }

        body.gunduz-modu {
            background: var(--bg-day);
            color: var(--text-day);
        }

        .kart { 
            background: var(--card-night); 
            border-radius: 28px; 
            padding: 25px; 
            width: 95%; 
            max-width: 450px; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); 
            text-align: center; 
            border: 1px solid rgba(255,255,255,0.05); 
            overflow-y: auto; 
            max-height: 90vh;
            transition: background 0.5s ease;
        }

        body.gunduz-modu .kart {
            background: var(--card-day);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.2);
        }

        h1 { font-size: 28px; font-weight: 900; color: var(--accent); margin-bottom: 5px; text-transform: uppercase; letter-spacing: -1px; }
        .rol-badge { font-size: 12px; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 20px; display: inline-block; margin-bottom: 20px; }
        
        input, select { width: 100%; padding: 15px; margin: 8px 0; border-radius: 12px; border: 2px solid var(--secondary); background: rgba(0,0,0,0.2); color: inherit; box-sizing: border-box; outline: none; font-weight: bold; }
        
        .buton { width: 100%; padding: 16px; margin: 8px 0; border-radius: 14px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px; position: relative; overflow: hidden; }
        .buton:active { transform: scale(0.98); }
        .buton-ana { background: var(--accent); color: #1e293b; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3); }
        .buton-vampir { background: var(--vampire); color: white; }
        .buton-doktor { background: var(--doctor); color: white; }
        .buton-ikincil { background: var(--secondary); color: white; }

        /* LOG ALANI */
        .oyun-log {
            background: rgba(0,0,0,0.1);
            border-radius: 12px;
            padding: 10px;
            margin-top: 15px;
            text-align: left;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
            border-left: 3px solid var(--accent);
        }

        .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--secondary); display: inline-flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 10px; }
        .oyuncu-satir { display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 10px; }

        /* Loader & Animations */
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Overlay */
        .katman { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center; padding: 20px; backdrop-filter: blur(5px); }
        .oludeniz { filter: grayscale(100%); opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body>

<div id="durumKatmani" class="katman">
    <div id="katmanEmoji" style="font-size: 80px; margin-bottom: 20px;"></div>
    <div id="katmanBaslik" style="font-size: 32px; font-weight: 900; color: white; margin-bottom: 10px;"></div>
    <div id="katmanAltMetin" style="font-size: 18px; color: #cbd5e1; max-width: 300px;"></div>
    <button class="buton buton-ana" style="width: 200px; margin-top: 30px;" onclick="katmaniKapat()">DEVAM ET</button>
</div>

<div class="kart">
    <div id="giris-ekrani">
        <div style="font-size: 50px;">üßõ‚Äç‚ôÇÔ∏è</div>
        <h1>VAMPƒ∞R K√ñYL√ú</h1>
        <div class="rol-badge">V2.0 - DOKTOR G√úNCELLEMESƒ∞</div>
        <input type="text" id="kullaniciAdi" placeholder="Oyuncu Adƒ±n">
        <button class="buton buton-ana" onclick="odaOlustur()">Yeni Oyun Kur (Admin)</button>
        <div style="display:flex; align-items:center; gap:10px; margin: 10px 0;">
            <div style="height:1px; background:rgba(255,255,255,0.2); flex:1;"></div>
            <span style="font-size:10px; opacity:0.5;">VEYA</span>
            <div style="height:1px; background:rgba(255,255,255,0.2); flex:1;"></div>
        </div>
        <input type="text" id="odaKoduGiris" placeholder="Oda Kodu (Varsa)">
        <button class="buton buton-ikincil" onclick="odayaKatil()">Odaya Katƒ±l</button>
    </div>

    <div id="lobi-ekrani" style="display: none;">
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 10px; letter-spacing: 2px; opacity: 0.7;">ODA KODU</div>
            <div id="odaKoduGoster" style="font-size: 40px; font-weight: 900; color: var(--accent); cursor:pointer;" onclick="koduKopyala()">000000</div>
            <div style="font-size: 10px; opacity: 0.5;">(Kopyalamak i√ßin tƒ±klayƒ±n)</div>
        </div>

        <div id="qr-alan" style="background: white; padding: 10px; border-radius: 10px; display: inline-block; margin-bottom: 15px; display: none;">
            <div id="qrcode"></div>
        </div>

        <div id="oyuncuListesi" style="max-height: 200px; overflow-y: auto; text-align: left;"></div>
        <div style="margin-top:15px; font-size: 12px; opacity: 0.6;"><span class="loader"></span> Oyuncular bekleniyor...</div>

        <div id="admin-panel" style="display:none; border-top: 1px dashed rgba(255,255,255,0.2); margin-top: 20px; padding-top: 20px;">
            <h3 style="margin:0 0 10px 0;">Y√ñNETƒ∞Cƒ∞ PANELƒ∞</h3>
            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                <input type="number" id="sureGece" placeholder="Gece (sn)" value="15" title="Gece S√ºresi">
                <input type="number" id="sureGunduz" placeholder="G√ºn (sn)" value="45" title="Tartƒ±≈üma S√ºresi">
            </div>
            <button class="buton buton-ana" onclick="oyunuBaslat()">OYUNU BA≈ûLAT</button>
            <p style="font-size: 10px; color: #ef4444;">‚ö† Admin oyundan √ßƒ±karsa oyun durur!</p>
        </div>
    </div>

    <div id="oyun-alani" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div id="rolGosterge" class="rol-badge" style="background: var(--accent); color: black; font-weight: bold;">?</div>
            <div id="sayacGosterge" style="font-size: 24px; font-weight: 900;">00:00</div>
        </div>

        <h2 id="asamaBaslik" style="margin: 10px 0;">GECE</h2>
        <p id="asamaAciklama" style="font-size: 14px; opacity: 0.8; margin-bottom: 20px;">...</p>

        <div id="aksiyonAlani"></div>
        
        <div class="oyun-log" id="oyunLoglari">
            <div>Oyun baƒülantƒ±sƒ± kuruldu...</div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // NOT: Ger√ßek bir projede bu anahtarlarƒ± gizlemelisiniz.
    const firebaseConfig = {
        apiKey: "AIzaSyBBXkGLUFGXfQsXhZ8uKpJZf6Y5hTjdK-8",
        authDomain: "vampir-koylu-oyunu.firebaseapp.com",
        databaseURL: "https://vampir-koylu-oyunu-default-rtdb.firebaseio.com",
        projectId: "vampir-koylu-oyunu"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Durum Deƒüi≈ükenleri
    let odaKodu = null;
    let ben = { ad: "", id: "", admin: false, rol: "", yasiyor: true };
    let oyunVerisi = {};

    // --- YARDIMCI FONKSƒ∞YONLAR ---
    window.koduKopyala = () => {
        navigator.clipboard.writeText(odaKodu);
        alert("Kod kopyalandƒ±: " + odaKodu);
    };

    function logEkle(mesaj) {
        const div = document.getElementById('oyunLoglari');
        div.innerHTML = `<div>> ${mesaj}</div>` + div.innerHTML;
    }

    function ekranDegis(id) {
        ['giris-ekrani', 'lobi-ekrani', 'oyun-alani'].forEach(e => document.getElementById(e).style.display = 'none');
        document.getElementById(id).style.display = 'block';
    }

    // --- LOBƒ∞ MANTIƒûI ---
    window.odaOlustur = () => {
        const ad = document.getElementById('kullaniciAdi').value;
        if(!ad) return alert("ƒ∞sim giriniz!");
        
        ben.ad = ad;
        ben.admin = true;
        odaKodu = Math.floor(100000 + Math.random() * 900000).toString();

        // Odayƒ± sƒ±fƒ±rla ve olu≈ütur
        set(ref(db, `vampirv2/${odaKodu}`), {
            durum: 'lobi',
            olay: 'Oda olu≈üturuldu.'
        }).then(() => {
            oyuncuEkle();
            qrOlustur();
        });
    };

    window.odayaKatil = () => {
        const ad = document.getElementById('kullaniciAdi').value;
        const kod = document.getElementById('odaKoduGiris').value;
        if(!ad || !kod) return alert("ƒ∞sim ve Kod gerekli!");
        
        ben.ad = ad;
        odaKodu = kod;
        oyuncuEkle();
    };

    function oyuncuEkle() {
        const pRef = push(ref(db, `vampirv2/${odaKodu}/oyuncular`), {
            ad: ben.ad,
            rol: '?',
            durum: 'sag',
            oy: 0
        });
        ben.id = pRef.key;
        
        ekranDegis('lobi-ekrani');
        document.getElementById('odaKoduGoster').innerText = odaKodu;
        if(ben.admin) document.getElementById('admin-panel').style.display = 'block';
        
        odayiDinle();
    }

    function qrOlustur() {
        document.getElementById('qr-alan').style.display = 'block';
        document.getElementById('qrcode').innerHTML = "";
        const url = window.location.href.split('?')[0] + "?room=" + odaKodu;
        new QRCode(document.getElementById("qrcode"), { text: url, width: 100, height: 100 });
    }

    // --- OYUN Dƒ∞NGƒ∞Sƒ∞ VE Dƒ∞NLEME ---
    function odayiDinle() {
        onValue(ref(db, `vampirv2/${odaKodu}`), (snap) => {
            const veri = snap.val();
            if(!veri) return alert("Oda kapandƒ± veya hatalƒ±.");
            oyunVerisi = veri;

            // 1. Lobi G√ºncellemesi
            if(veri.durum === 'lobi') {
                const liste = document.getElementById('oyuncuListesi');
                liste.innerHTML = "";
                if(veri.oyuncular) {
                    Object.values(veri.oyuncular).forEach(p => {
                        liste.innerHTML += `<div class="oyuncu-satir"><div class="avatar">üë§</div> ${p.ad}</div>`;
                    });
                }
            } 
            // 2. Oyun Ba≈üladƒ±
            else {
                if(document.getElementById('lobi-ekrani').style.display === 'block') {
                    ekranDegis('oyun-alani');
                    baslangicAnimasyonu();
                }
                arayuzGuncelle(veri);
            }
        });
    }

    function baslangicAnimasyonu() {
        const benimVerim = oyunVerisi.oyuncular[ben.id];
        ben.rol = benimVerim.rol;
        ben.yasiyor = benimVerim.durum === 'sag';
        
        let emoji = ben.rol === 'VAMPƒ∞R' ? 'üßõ‚Äç‚ôÇÔ∏è' : (ben.rol === 'DOKTOR' ? '‚öïÔ∏è' : 'üë®‚Äçüåæ');
        document.getElementById('rolGosterge').innerText = ben.rol;
        katmaniGoster(emoji, "ROL√úN: " + ben.rol, "Hazƒ±r ol, oyun ba≈ülƒ±yor!");
    }

    function arayuzGuncelle(veri) {
        // G√ºnd√ºz/Gece Temasƒ±
        const body = document.body;
        const baslik = document.getElementById('asamaBaslik');
        const aciklama = document.getElementById('asamaAciklama');
        const aksiyon = document.getElementById('aksiyonAlani');
        const sayac = document.getElementById('sayacGosterge');

        if(veri.kazanan) {
            katmaniGoster('üèÜ', veri.kazanan + " KAZANDI!", "Oyun bitti. Sayfa yenileniyor...");
            setTimeout(() => location.reload(), 5000);
            return;
        }

        // √ñl√º Kontrol√º
        if(veri.oyuncular[ben.id].durum === 'olu') {
            document.querySelector('.kart').classList.add('oludeniz');
            aciklama.innerText = "Maalesef √∂ld√ºn. Sadece izleyebilirsin.";
            aksiyon.innerHTML = "";
            return;
        }

        sayac.innerText = "‚è≥ " + veri.sayac;

        // Fazlara G√∂re UI
        if(veri.durum === 'gece') {
            body.className = ''; // Gece Modu
            baslik.innerText = "üåô GECE VAKTƒ∞";
            
            if(ben.rol === 'VAMPƒ∞R') {
                aciklama.innerText = "Kimi √∂ld√ºrmek istersin?";
                butonlariCiz(veri.oyuncular, 'oldur');
            } else if(ben.rol === 'DOKTOR') {
                aciklama.innerText = "Kimi iyile≈ütirmek istersin?";
                butonlariCiz(veri.oyuncular, 'iyilestir');
            } else {
                aciklama.innerText = "Gece oldu, herkes uyuyor... Ses √ßƒ±karma!";
                aksiyon.innerHTML = "<i style='opacity:0.5'>Sabahƒ± bekle...</i>";
            }
        } 
        else if(veri.durum === 'tartisma') {
            body.className = 'gunduz-modu';
            baslik.innerText = "‚òÄÔ∏è G√úND√úZ - TARTI≈ûMA";
            aciklama.innerText = veri.olay || "Gece bitti. Olaylarƒ± tartƒ±≈üƒ±n.";
            aksiyon.innerHTML = "";
        }
        else if(veri.durum === 'oylama') {
            body.className = 'gunduz-modu';
            baslik.innerText = "üó≥Ô∏è OYLAMA ZAMANI";
            aciklama.innerText = "≈û√ºphelendiƒüin ki≈üiyi asmak i√ßin oy ver.";
            if(!ben.oyVerdim) butonlariCiz(veri.oyuncular, 'oyla');
            else aksiyon.innerHTML = "Oyun kullanƒ±ldƒ±. Sonu√ß bekleniyor...";
        }
    }

    function butonlariCiz(oyuncular, tip) {
        const div = document.getElementById('aksiyonAlani');
        div.innerHTML = "";
        Object.entries(oyuncular).forEach(([id, p]) => {
            if(p.durum === 'sag' && id !== ben.id) {
                let renk = tip === 'oldur' ? 'buton-vampir' : (tip === 'iyilestir' ? 'buton-doktor' : 'buton-ikincil');
                let metin = tip === 'oldur' ? '√ñLD√úR' : (tip === 'iyilestir' ? 'KURTAR' : 'OY VER');
                
                // Vampir diƒüer vampiri √∂ld√ºremez
                if(tip === 'oldur' && p.rol === 'VAMPƒ∞R') return;

                div.innerHTML += `<button class="buton ${renk}" onclick="aksiyonYap('${id}', '${tip}')">
                    <span style="float:left">${p.ad}</span>
                    <span style="float:right; font-size:10px;">${metin}</span>
                </button>`;
            }
        });
    }

    window.aksiyonYap = (hedefId, tip) => {
        if(tip === 'oldur') update(ref(db, `vampirv2/${odaKodu}/geceHedef`), { kurban: hedefId });
        if(tip === 'iyilestir') update(ref(db, `vampirv2/${odaKodu}/geceHedef`), { doktor: hedefId });
        if(tip === 'oyla') {
            ben.oyVerdim = true;
            document.getElementById('aksiyonAlani').innerHTML = "Oy verildi...";
            // Oyu arttƒ±r
            const hedefRef = ref(db, `vampirv2/${odaKodu}/oyuncular/${hedefId}/oy`);
            onValue(hedefRef, (s) => {
                update(ref(db, `vampirv2/${odaKodu}/oyuncular/${hedefId}`), { oy: (s.val()||0) + 1 });
            }, {onlyOnce:true});
        }
    };

    // --- ADMƒ∞N OYUN MANTIƒûI (SERVER Gƒ∞Bƒ∞ DAVRANIR) ---
    window.oyunuBaslat = () => {
        if(!ben.admin) return;
        
        onValue(ref(db, `vampirv2/${odaKodu}/oyuncular`), (snap) => {
            const oyucular = snap.val();
            const ids = Object.keys(oyucular);
            if(ids.length < 3) return alert("En az 3 oyuncu lazƒ±m!"); // Doktor i√ßin min 3

            // Rolleri Daƒüƒ±t (1 Vampir, 1 Doktor, Gerisi K√∂yl√º)
            ids.sort(() => Math.random() - 0.5);
            let updates = {};
            ids.forEach((id, index) => {
                let rol = 'K√ñYL√ú';
                if(index === 0) rol = 'VAMPƒ∞R';
                else if(index === 1) rol = 'DOKTOR';
                updates[`vampirv2/${odaKodu}/oyuncular/${id}/rol`] = rol;
            });
            
            update(ref(db), updates).then(() => oyunDongusuBaslat());

        }, {onlyOnce: true});
    };

    async function oyunDongusuBaslat() {
        const geceSure = parseInt(document.getElementById('sureGece').value);
        const gunduzSure = parseInt(document.getElementById('sureGunduz').value);

        while(true) {
            // 1. GECE
            await asamaAyarla('gece', geceSure, "Vampir ve Doktor hazƒ±rlanƒ±yor...");
            await update(ref(db, `vampirv2/${odaKodu}/geceHedef`), { kurban: "", doktor: "" });
            await bekle(geceSure);

            // Gece Sonu√ßlarƒ±nƒ± Hesapla
            const sonuc = await geceSonuclari();
            if(await oyunBittiMi()) break;

            // 2. TARTI≈ûMA
            await asamaAyarla('tartisma', gunduzSure, sonuc);
            await bekle(gunduzSure);

            // 3. OYLAMA
            await asamaAyarla('oylama', 15, "Asƒ±lacak ki≈üiyi se√ßin.");
            await sifirlaOylar();
            await bekle(15);

            // Oylama Sonu√ßlarƒ±
            const asilan = await oylamaSonuclari();
            if(await oyunBittiMi()) break;
        }
    }

    async function asamaAyarla(durum, sure, olay) {
        await update(ref(db, `vampirv2/${odaKodu}`), { durum, sayac: sure, olay });
        // Sayacƒ± azaltma d√∂ng√ºs√º
        for(let i=sure; i>0; i--) {
            await update(ref(db, `vampirv2/${odaKodu}`), { sayac: i });
            await new Promise(r => setTimeout(r, 1000));
        }
    }

    function bekle(sn) { return new Promise(r => setTimeout(r, 100)); } // Saya√ß yukarƒ±da hallediliyor

    async function geceSonuclari() {
        const snap = await getSnap(`vampirv2/${odaKodu}`);
        const hedef = snap.val().geceHedef || {};
        const kurban = hedef.kurban;
        const kurtarilan = hedef.doktor;
        let mesaj = "Gece sakin ge√ßti.";

        if(kurban) {
            if(kurban === kurtarilan) {
                mesaj = "Vampir saldƒ±rdƒ± ama DOKTOR yeti≈üti!";
            } else {
                const pAd = snap.val().oyuncular[kurban].ad;
                mesaj = `Vampir ${pAd} isimli oyuncuyu √∂ld√ºrd√º!`;
                await update(ref(db, `vampirv2/${odaKodu}/oyuncular/${kurban}`), { durum: 'olu' });
            }
        }
        return mesaj;
    }

    async function oylamaSonuclari() {
        const snap = await getSnap(`vampirv2/${odaKodu}/oyuncular`);
        const list = Object.entries(snap.val());
        let enCok = 0;
        let kurbanId = null;

        list.forEach(([id, p]) => {
            if(p.oy > enCok) { enCok = p.oy; kurbanId = id; }
        });

        if(kurbanId && enCok > 0) {
            await update(ref(db, `vampirv2/${odaKodu}/oyuncular/${kurbanId}`), { durum: 'olu' });
            return `${snap.val()[kurbanId].ad} oylama sonucu asƒ±ldƒ±.`;
        }
        return "Kimse asƒ±lmadƒ±.";
    }

    async function sifirlaOylar() {
        const snap = await getSnap(`vampirv2/${odaKodu}/oyuncular`);
        Object.keys(snap.val()).forEach(k => {
            update(ref(db, `vampirv2/${odaKodu}/oyuncular/${k}`), { oy: 0 });
        });
    }

    async function oyunBittiMi() {
        const snap = await getSnap(`vampirv2/${odaKodu}/oyuncular`);
        const p = Object.values(snap.val());
        const vampirler = p.filter(x => x.rol === 'VAMPƒ∞R' && x.durum === 'sag').length;
        const koyluler = p.filter(x => x.rol !== 'VAMPƒ∞R' && x.durum === 'sag').length;

        if(vampirler === 0) { await bitir('K√ñYL√úLER'); return true; }
        if(vampirler >= koyluler) { await bitir('VAMPƒ∞RLER'); return true; }
        return false;
    }

    async function bitir(kim) { await update(ref(db, `vampirv2/${odaKodu}`), { kazanan: kim }); }
    function getSnap(yol) { return new Promise(r => onValue(ref(db, yol), r, {onlyOnce:true})); }

    // UI YARDIMCILARI
    window.katmaniGoster = (emoji, baslik, alt) => {
        const k = document.getElementById('durumKatmani');
        k.style.display = 'flex';
        document.getElementById('katmanEmoji').innerText = emoji;
        document.getElementById('katmanBaslik').innerText = baslik;
        document.getElementById('katmanAltMetin').innerText = alt;
    };
    window.katmaniKapat = () => document.getElementById('durumKatmani').style.display = 'none';
    
    // URL Parametre Kontrol√º
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.has('room')) document.getElementById('odaKoduGiris').value = urlParams.get('room');
    };
</script>
</body>
</html>
